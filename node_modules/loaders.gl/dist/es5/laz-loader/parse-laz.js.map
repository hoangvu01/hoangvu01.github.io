{"version":3,"sources":["../../../src/laz-loader/parse-laz.js"],"names":["parseLAZ","rawData","skip","onParseData","dataHandler","LASFile","open","then","isOpen","data","getHeader","header","Unpacker","getUnpacker","totalToRead","pointsCount","Math","max","totalRead","reader","readData","chunk","count","unpacker","buffer","hasMoreData","versionAsString","isCompressed","close","catch","e"],"mappings":";;;;;;;AACA;;;;;;;;;;AAEA;;;;;AAKO,SAASA,QAAT,CAAkBC,OAAlB,EAA2BC,IAA3B,EAAiCC,WAAjC,EAA8C;AACnD,MAAMC,WAAW,GAAG,IAAIC,eAAJ,CAAYJ,OAAZ,CAApB;AACA,SACEG,WAAW,CACRE,IADH,GAEE;AAFF,GAGGC,IAHH,CAGQ,YAAM;AACVH,IAAAA,WAAW,CAACI,MAAZ,GAAqB,IAArB;AACA,WAAOJ,WAAP;AACD,GANH,EAOE;AAPF,GAQGG,IARH,CAQQ,UAAAE,IAAI;AAAA,WAAIA,IAAI,CAACC,SAAL,GAAiBH,IAAjB,CAAsB,UAAAI,MAAM;AAAA,aAAI,CAACF,IAAD,EAAOE,MAAP,CAAJ;AAAA,KAA5B,CAAJ;AAAA,GARZ,EASE;AATF,GAUGJ,IAVH,CAUQ,gBAAoB;AAAA;AAAA,QAAlBE,IAAkB;AAAA,QAAZE,MAAY;;AACxB,QAAMC,QAAQ,GAAGH,IAAI,CAACI,WAAL,EAAjB;AAEA,QAAMC,WAAW,GAAGH,MAAM,CAACI,WAAP,GAAqBC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYf,IAAZ,CAAzC;AACA,QAAIgB,SAAS,GAAG,CAAhB;;AAEA,QAAMC,MAAM,GAAG,SAATA,MAAS;AAAA,aACbV,IAAI,CAACW,QAAL,CAAc,OAAO,GAArB,EAA0B,CAA1B,EAA6BlB,IAA7B,EAAmCK,IAAnC,CAAwC,UAAAc,KAAK,EAAI;AAC/CH,QAAAA,SAAS,IAAIG,KAAK,CAACC,KAAnB;AACA,YAAMC,QAAQ,GAAG,IAAIX,QAAJ,CAAaS,KAAK,CAACG,MAAnB,EAA2BH,KAAK,CAACC,KAAjC,EAAwCX,MAAxC,CAAjB,CAF+C,CAG/C;AACA;;AACAR,QAAAA,WAAW,CAACoB,QAAD,EAAWL,SAAS,GAAGJ,WAAvB,CAAX;;AAEA,YAAIO,KAAK,CAACI,WAAN,IAAqBP,SAAS,GAAGJ,WAArC,EAAkD;AAChD,iBAAOK,MAAM,EAAb;AACD;;AAEDR,QAAAA,MAAM,CAACO,SAAP,GAAmBA,SAAnB;AACAP,QAAAA,MAAM,CAACe,eAAP,GAAyBL,KAAK,CAACK,eAA/B;AACAf,QAAAA,MAAM,CAACgB,YAAP,GAAsBN,KAAK,CAACM,YAA5B;AACA,eAAO,CAACN,KAAD,EAAQV,MAAR,CAAP;AACD,OAfD,CADa;AAAA,KAAf;;AAkBA,WAAOQ,MAAM,EAAb;AACD,GAnCH,EAoCE;AApCF,GAqCGZ,IArCH,CAqCQ,iBAAoB;AAAA;AAAA,QAAlBE,IAAkB;AAAA,QAAZE,MAAY;;AACxBP,IAAAA,WAAW,CAACwB,KAAZ,GAAoBrB,IAApB,CAAyB,YAAM;AAC7BH,MAAAA,WAAW,CAACI,MAAZ,GAAqB,KAArB,CAD6B,CAE7B;;AACA,aAAOG,MAAP;AACD,KAJD;AAKD,GA3CH,EA4CE;AA5CF,GA6CGkB,KA7CH,CA6CS,UAAAC,CAAC,EAAI;AACV;AACA,QAAI1B,WAAW,CAACI,MAAhB,EAAwB;AACtB,aAAOJ,WAAW,CAACwB,KAAZ,GAAoBrB,IAApB,CAAyB,YAAM;AACpCH,QAAAA,WAAW,CAACI,MAAZ,GAAqB,KAArB;AACA,cAAMsB,CAAN;AACD,OAHM,CAAP;AAID;;AACD,UAAMA,CAAN;AACD,GAtDH,CADF;AAyDD","sourcesContent":["// ported and es6-ified from https://github.com/verma/plasio/\nimport {LASFile} from './laslaz';\n\n/**\n * parse laz data\n * @param {Binary} data\n * @return {*} parsed point cloud\n */\nexport function parseLAZ(rawData, skip, onParseData) {\n  const dataHandler = new LASFile(rawData);\n  return (\n    dataHandler\n      .open()\n      // open data\n      .then(() => {\n        dataHandler.isOpen = true;\n        return dataHandler;\n      })\n      // attch header\n      .then(data => data.getHeader().then(header => [data, header]))\n      // start loading\n      .then(([data, header]) => {\n        const Unpacker = data.getUnpacker();\n\n        const totalToRead = header.pointsCount / Math.max(1, skip);\n        let totalRead = 0;\n\n        const reader = () =>\n          data.readData(1000 * 100, 0, skip).then(chunk => {\n            totalRead += chunk.count;\n            const unpacker = new Unpacker(chunk.buffer, chunk.count, header);\n            // surface unpacker and progress via call back\n            // use unpacker.pointsCount and unpacker.getPoint(i) to handle data in app\n            onParseData(unpacker, totalRead / totalToRead);\n\n            if (chunk.hasMoreData && totalRead < totalToRead) {\n              return reader();\n            }\n\n            header.totalRead = totalRead;\n            header.versionAsString = chunk.versionAsString;\n            header.isCompressed = chunk.isCompressed;\n            return [chunk, header];\n          });\n\n        return reader();\n      })\n      // done loading, close file\n      .then(([data, header]) => {\n        dataHandler.close().then(() => {\n          dataHandler.isOpen = false;\n          // trim the LASFile which we don't really want to pass to the user\n          return header;\n        });\n      })\n      // handle exceptions\n      .catch(e => {\n        // make sure the data is closed, if the data is open close and then fail\n        if (dataHandler.isOpen) {\n          return dataHandler.close().then(() => {\n            dataHandler.isOpen = false;\n            throw e;\n          });\n        }\n        throw e;\n      })\n  );\n}\n"],"file":"parse-laz.js"}