{"version":3,"sources":["../../../src/draco-loader/draco-decoder.js"],"names":["draco3d","require","GEOMETRY_TYPE","TRIANGULAR_MESH","POINT_CLOUD","ATTRIBUTE_MAP","position","normal","color","uv","DRACODecoder","constructor","decoderModule","createDecoderModule","destroy","destroyGeometry","dracoGeometry","decode","arrayBuffer","buffer","DecoderBuffer","Init","Int8Array","byteLength","decoder","Decoder","data","dracoStatus","geometryType","GetEncodedGeometryType","Mesh","DecodeBufferToMesh","header","type","faceCount","num_faces","attributeCount","num_attributes","vertexCount","num_points","PointCloud","DecodeBufferToPointCloud","Error","ok","ptr","message","error_msg","extractDRACOGeometry","geometry","attributes","getAttributes","positionAttribute","getPositionAttribute","getPositionAttributeMetadata","POSITION","indices","drawMode","getMeshStripIndices","getMeshFaceIndices","positionAttributeId","GetAttributeId","dracoAttribute","GetAttribute","getAttributeTypedArray","Float32Array","typedArray","metadata","posTransform","AttributeQuantizationTransform","InitFromAttribute","isQuantized","maxRange","range","numQuantizationBits","quantization_bits","minValues","i","min_value","attributeName","attributeType","attributeId","numFaces","numIndices","Uint32Array","dracoArray","DracoInt32Array","GetFaceFromMesh","index","GetValue","GetTriangleStripsFromMesh","size","numComponents","num_components","numPoints","numValues","DracoFloat32Array","GetAttributeFloatForAllPoints","DracoInt8Array","GetAttributeInt8ForAllPoints","Int16Array","DracoInt16Array","GetAttributeInt16ForAllPoints","Int32Array","GetAttributeInt32ForAllPoints","Uint8Array","DracoUInt8Array","GetAttributeUInt8ForAllPoints","Uint16Array","DracoUInt16Array","GetAttributeUInt16ForAllPoints","DracoUInt32Array","GetAttributeUInt32ForAllPoints","errorMsg","components"],"mappings":"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","sourcesContent":["// DRACO decompressor\n\nconst draco3d = require('draco3d');\n// const assert = require('assert');\n\nconst GEOMETRY_TYPE = {\n  TRIANGULAR_MESH: 0,\n  POINT_CLOUD: 1\n};\n\n// Native Draco attribute names to GLTF attribute names.\nconst ATTRIBUTE_MAP = {\n  position: 'POSITION',\n  normal: 'NORMAL',\n  color: 'COLOR_0',\n  uv: 'TEXCOORD_0'\n};\n\nexport default class DRACODecoder {\n  constructor() {\n    this.decoderModule = draco3d.createDecoderModule({});\n  }\n\n  // isVersionSupported(version, callback) {\n  //   DRACOLoader.getDecoderModule()\n  //     .then(function (module) {\n  //       callback(module.decoder.isVersionSupported(version));\n  //     });\n  // }\n\n  // getAttributeOptions(attributeName) {\n  //     if (typeof this.attributeOptions[attributeName] === 'undefined')\n  //       this.attributeOptions[attributeName] = {};\n  //     return this.attributeOptions[attributeName];\n  // }\n\n  destroy() {\n    // this.decoderModule.destroy();\n  }\n\n  destroyGeometry(dracoGeometry) {\n    if (dracoGeometry) {\n      this.decoderModule.destroy(dracoGeometry.dracoGeometry);\n    }\n  }\n\n  // NOTE: caller must call `destroyGeometry` on the return value after using it\n  decode(arrayBuffer) {\n    const buffer = new this.decoderModule.DecoderBuffer();\n    buffer.Init(new Int8Array(arrayBuffer), arrayBuffer.byteLength);\n\n    const decoder = new this.decoderModule.Decoder();\n\n    const data = {};\n    let dracoStatus;\n    let dracoGeometry;\n\n    try {\n      const geometryType = decoder.GetEncodedGeometryType(buffer);\n      switch (geometryType) {\n\n      case this.decoderModule.TRIANGULAR_MESH:\n        dracoGeometry = new this.decoderModule.Mesh();\n        dracoStatus = decoder.DecodeBufferToMesh(buffer, dracoGeometry);\n        data.header = {\n          type: GEOMETRY_TYPE.TRIANGULAR_MESH,\n          faceCount: dracoGeometry.num_faces(),\n          attributeCount: dracoGeometry.num_attributes(),\n          vertexCount: dracoGeometry.num_points()\n        };\n        break;\n\n      case this.decoderModule.POINT_CLOUD:\n        dracoGeometry = new this.decoderModule.PointCloud();\n        dracoStatus = decoder.DecodeBufferToPointCloud(buffer, dracoGeometry);\n        data.header = {\n          type: GEOMETRY_TYPE.POINT_CLOUD,\n          attributeCount: dracoGeometry.num_attributes(),\n          vertexCount: dracoGeometry.num_points()\n        };\n        break;\n\n      default:\n        throw new Error('Unknown DRACO geometry type.');\n      }\n\n      if (!dracoStatus.ok() || !dracoGeometry.ptr) {\n        const message = `DRACO decompression failed: ${dracoStatus.error_msg()}`;\n        // console.error(message);\n        if (dracoGeometry) {\n          this.decoderModule.destroy(dracoGeometry);\n        }\n        throw new Error(message);\n      }\n\n      this.extractDRACOGeometry(decoder, dracoGeometry, data);\n\n    } finally {\n      this.decoderModule.destroy(decoder);\n      this.decoderModule.destroy(buffer);\n    }\n\n    return data;\n  }\n\n  extractDRACOGeometry(decoder, dracoGeometry, geometry, geometryType) {\n    // const numPoints = dracoGeometry.num_points();\n    // const numAttributes = dracoGeometry.num_attributes();\n\n    // Structure for converting to WebGL framework specific attributes later\n    const attributes = this.getAttributes(decoder, dracoGeometry);\n\n    const positionAttribute = this.getPositionAttribute(decoder, dracoGeometry);\n\n    this.getPositionAttributeMetadata(positionAttribute);\n\n    attributes.POSITION = positionAttribute;\n\n    // For meshes, we need indices to define the faces.\n    if (geometryType === this.decoderModule.TRIANGULAR_MESH) {\n      attributes.indices = this.drawMode === 'TRIANGLE_STRIP' ?\n        this.getMeshStripIndices() :\n        this.getMeshFaceIndices();\n    }\n\n    attributes.drawMode = this.drawMode;\n\n    geometry.attributes = attributes;\n\n    return geometry;\n  }\n\n  getPositionAttribute(decoder, dracoGeometry) {\n    // Ensure we at least have position attribute.\n    const positionAttributeId = decoder.GetAttributeId(dracoGeometry, this.decoderModule.POSITION);\n    if (positionAttributeId === -1) {\n      throw new Error('DRACO decompressor: No position attribute found.');\n    }\n\n    const dracoAttribute = decoder.GetAttribute(dracoGeometry, positionAttributeId);\n    const {typedArray} = this.getAttributeTypedArray(\n      decoder, dracoGeometry, dracoAttribute, Float32Array, 'position');\n    return typedArray;\n  }\n\n  getPositionAttributeMetadata(positionAttribute) {\n    this.metadata = this.metadata || {};\n    this.metadata.attributes = this.metadata.attributes || {};\n\n    const posTransform = new this.decoderModule.AttributeQuantizationTransform();\n    if (posTransform.InitFromAttribute(positionAttribute)) {\n      // Quantized attribute. Store the quantization parameters into the\n      // THREE.js attribute.\n      this.metadata.attributes.position.isQuantized = true;\n      this.metadata.attributes.position.maxRange = posTransform.range();\n      this.metadata.attributes.position.numQuantizationBits = posTransform.quantization_bits();\n      this.metadata.attributes.position.minValues = new Float32Array(3);\n      for (let i = 0; i < 3; ++i) {\n        this.metadata.attributes.position.minValues[i] = posTransform.min_value(i);\n      }\n    }\n    this.decoderModule.destroy(posTransform);\n  }\n\n  getAttributes(decoder, dracoGeometry) {\n    const attributes = {};\n    // const attributeUniqueIdMap = {};\n\n    // Add native Draco attribute type to geometry.\n    for (const attributeName in ATTRIBUTE_MAP) {\n      // The native attribute type is only used when no unique Id is provided.\n      // For example, loading .drc files.\n\n      // if (attributeUniqueIdMap[attributeName] === undefined) {\n      const attributeType = this.decoderModule[attributeName];\n      const attributeId = decoder.GetAttributeId(dracoGeometry, attributeType);\n      if (attributeId !== -1) {\n        const dracoAttribute = decoder.GetAttribute(dracoGeometry, attributeId);\n        this.getAttributeTypedArray(\n          decoder, dracoGeometry, dracoAttribute, Float32Array, attributeName\n        );\n      }\n      // }\n    }\n\n    // // Add attributes of user specified unique id. E.g. GLTF models.\n    // for (const attributeName in attributeUniqueIdMap) {\n    //   const attributeType = attributeTypeMap[attributeName] || Float32Array;\n    //   const attributeId = attributeUniqueIdMap[attributeName];\n    //   const attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeId);\n    //   this.getAttributeTypedArray(decoder, dracoGeometry, attribute,attributeName,attributeType);\n    // }\n\n    return attributes;\n  }\n\n  // For meshes, we need indices to define the faces.\n  getMeshFaceIndices(decoder, dracoGeometry) {\n    // Example on how to retrieve mesh and attributes.\n    const numFaces = dracoGeometry.num_faces();\n\n    const numIndices = numFaces * 3;\n    const indices = new Uint32Array(numIndices);\n    const dracoArray = new this.decoderModule.DracoInt32Array();\n    for (let i = 0; i < numFaces; ++i) {\n      decoder.GetFaceFromMesh(dracoGeometry, i, dracoArray);\n      const index = i * 3;\n      indices[index] = dracoArray.GetValue(0);\n      indices[index + 1] = dracoArray.GetValue(1);\n      indices[index + 2] = dracoArray.GetValue(2);\n    }\n\n    this.decoderModule.destroy(dracoArray);\n    return indices;\n  }\n\n  // For meshes, we need indices to define the faces.\n  getMeshStripIndices(decoder, dracoGeometry) {\n    const dracoArray = new this.decoderModule.DracoInt32Array();\n    /* const numStrips = */ decoder.GetTriangleStripsFromMesh(dracoGeometry, dracoArray);\n    const indices = new Uint32Array(dracoArray.size());\n    for (let i = 0; i < dracoArray.size(); ++i) {\n      indices[i] = dracoArray.GetValue(i);\n    }\n    this.decoderModule.destroy(dracoArray);\n    return indices;\n  }\n\n  getAttributeTypedArray(decoder, dracoGeometry, dracoAttribute, attributeType, attributeName) {\n    if (dracoAttribute.ptr === 0) {\n      const message = `DRACO decode bad attribute ${attributeName}`;\n      // console.error(message);\n      throw new Error(message);\n    }\n\n    const numComponents = dracoAttribute.num_components();\n    const numPoints = dracoGeometry.num_points();\n    const numValues = numPoints * numComponents;\n\n    let dracoArray;\n    let typedArray;\n\n    switch (attributeType) {\n\n    case Float32Array:\n      dracoArray = new this.decoderModule.DracoFloat32Array();\n      decoder.GetAttributeFloatForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Float32Array(numValues);\n      break;\n\n    case Int8Array:\n      dracoArray = new this.decoderModule.DracoInt8Array();\n      decoder.GetAttributeInt8ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Int8Array(numValues);\n      break;\n\n    case Int16Array:\n      dracoArray = new this.decoderModule.DracoInt16Array();\n      decoder.GetAttributeInt16ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Int16Array(numValues);\n      break;\n\n    case Int32Array:\n      dracoArray = new this.decoderModule.DracoInt32Array();\n      decoder.GetAttributeInt32ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Int32Array(numValues);\n      break;\n\n    case Uint8Array:\n      dracoArray = new this.decoderModule.DracoUInt8Array();\n      decoder.GetAttributeUInt8ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Uint8Array(numValues);\n      break;\n\n    case Uint16Array:\n      dracoArray = new this.decoderModule.DracoUInt16Array();\n      decoder.GetAttributeUInt16ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Uint16Array(numValues);\n      break;\n\n    case Uint32Array:\n      dracoArray = new this.decoderModule.DracoUInt32Array();\n      decoder.GetAttributeUInt32ForAllPoints(dracoGeometry, dracoAttribute, dracoArray);\n      typedArray = new Uint32Array(numValues);\n      break;\n\n    default:\n      const errorMsg = 'DRACO decoder: unexpected attribute type.';\n      // console.error(errorMsg);\n      throw new Error(errorMsg);\n\n    }\n\n    // Copy data from decoder.\n    for (let i = 0; i < numValues; i++) {\n      typedArray[i] = dracoArray.GetValue(i);\n    }\n\n    this.decoderModule.destroy(dracoArray);\n\n    return {typedArray, components: numComponents};\n  }\n}\n"],"file":"draco-decoder.js"}