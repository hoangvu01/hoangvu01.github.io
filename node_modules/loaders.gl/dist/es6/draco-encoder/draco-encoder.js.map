{"version":3,"sources":["../../../src/draco-encoder/draco-encoder.js"],"names":["draco3d","require","assert","DEFAULT_ENCODING_OPTIONS","speed","method","quantization","POSITION","DRACOEncoder","constructor","encoderModule","createEncoderModule","encoder","Encoder","destroy","this","destroyEncodedObject","object","setOptions","opts","SetSpeedOptions","SetEncodingMethod","attribute","bits","SetAttributeQuantization","encodeCloud","mesh","decoder","newMesh","prepareMesh","encodedData","DracoInt8Array","encodedLen","EncodeMeshToDracoBuffer","Error","console","log","outputBuffer","ArrayBuffer","outputData","Int8Array","i","GetValue","encodeMesh","numFaces","num_faces","numIndices","numPoints","num_points","indices","Uint32Array","meshBuilder","MeshBuilder","integerArray","decoderModule","DracoInt32Array","GetFaceFromMesh","index","Mesh","AddFacesToMesh","_prepareMeshAttributes","attrs","NORMAL","COLOR","TEX_COORD","Object","keys","forEach","attr","stride","numValues","decoderAttr","encoderAttr","attrId","GetAttributeId","GetAttribute","attributeData","DracoFloat32Array","GetAttributeFloatForAllPoints","size","attributeDataArray","Float32Array","AddFloatAttributeToMesh"],"mappings":"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","sourcesContent":["// Copyright 2017 The Draco Authors.\n//\n// Licensed under the Apache License, Version 2.0 (the 'License');\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an 'AS IS' BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n\n/* eslint-disable no-console */\n/* global console */\nconst draco3d = require('draco3d');\nconst assert = require('assert');\n\nconst DEFAULT_ENCODING_OPTIONS = {\n  speed: [5, 5],\n  method: 'MESH_EDGEBREAKER_ENCODING',\n  quantization: {\n    POSITION: 10\n  }\n};\n\nexport default class DRACOEncoder {\n  constructor() {\n    this.encoderModule = draco3d.createEncoderModule({});\n    this.encoder = new this.encoderModule.Encoder();\n  }\n\n  destroy() {\n    this.this.encoderModule.destroy(this.encoder);\n    this.encoder = null;\n    this.encoderModule = null;\n  }\n\n  destroyEncodedObject(object) {\n    if (object) {\n      this.encoderModule.destroy(object);\n    }\n  }\n\n  // Set encoding options.\n  setOptions(opts) {\n    if ('speed' in opts) {\n      this.encoder.SetSpeedOptions(...opts.speed);\n    }\n    if ('method' in opts) {\n      this.encoder.SetEncodingMethod(this.encoderModule[opts.method]);\n    }\n    if ('quantization' in opts) {\n      for (const attribute in opts.quantization) {\n        const bits = opts.quantization[attribute];\n        this.encoder.SetAttributeQuantization(this.encoderModule[attribute], bits);\n      }\n    }\n  }\n\n  encodeCloud(mesh, decoder) {\n\n    const newMesh = this.prepareMesh(mesh, decoder);\n\n    this.setOptions(DEFAULT_ENCODING_OPTIONS);\n\n    // Encoding.\n    // console.log('Encoding...');\n    const encodedData = new this.encoderModule.DracoInt8Array();\n    const encodedLen = this.encoder.EncodeMeshToDracoBuffer(newMesh, encodedData);\n    this.encoderModule.destroy(newMesh);\n    if (!(encodedLen > 0)) {\n      throw new Error('Draco encoding failed.');\n    }\n\n    console.log(`Encoded size is ${encodedLen}`);\n\n    // Copy encoded data to buffer.\n    const outputBuffer = new ArrayBuffer(encodedLen);\n    const outputData = new Int8Array(outputBuffer);\n    for (let i = 0; i < encodedLen; ++i) {\n      outputData[i] = encodedData.GetValue(i);\n    }\n\n    this.encoderModule.destroy(encodedData);\n\n    return outputData;\n  }\n\n  encodeMesh(mesh, decoder) {\n\n    const newMesh = this.prepareMesh(mesh, decoder);\n\n    this.setOptions(DEFAULT_ENCODING_OPTIONS);\n\n    // Encoding.\n    // console.log('Encoding...');\n    const encodedData = new this.encoderModule.DracoInt8Array();\n    const encodedLen = this.encoder.EncodeMeshToDracoBuffer(newMesh, encodedData);\n    this.encoderModule.destroy(newMesh);\n    if (!(encodedLen > 0)) {\n      throw new Error('Draco encoding failed.');\n    }\n\n    console.log(`Encoded size is ${encodedLen}`);\n\n    // Copy encoded data to buffer.\n    const outputBuffer = new ArrayBuffer(encodedLen);\n    const outputData = new Int8Array(outputBuffer);\n    for (let i = 0; i < encodedLen; ++i) {\n      outputData[i] = encodedData.GetValue(i);\n    }\n\n    this.encoderModule.destroy(encodedData);\n    // this.encoderModule.destroy(meshBuilder);\n\n    return outputData;\n  }\n\n  prepareMesh(mesh, decoder) {\n    const numFaces = mesh.num_faces();\n    const numIndices = numFaces * 3;\n    const numPoints = mesh.num_points();\n    const indices = new Uint32Array(numIndices);\n\n    console.log(`Number of faces ${numFaces}`);\n    console.log(`Number of vertices ${numPoints}`);\n\n    const meshBuilder = new this.encoderModule.MeshBuilder();\n\n    // Add Faces to mesh\n    const integerArray = new this.decoderModule.DracoInt32Array();\n    for (let i = 0; i < numFaces; ++i) {\n      decoder.GetFaceFromMesh(mesh, i, integerArray);\n      const index = i * 3;\n      indices[index] = integerArray.GetValue(0);\n      indices[index + 1] = integerArray.GetValue(1);\n      indices[index + 2] = integerArray.GetValue(2);\n    }\n    this.decoderModule.destroy(integerArray);\n\n    // Create a mesh object for storing mesh data.\n    const newMesh = new this.encoderModule.Mesh();\n    meshBuilder.AddFacesToMesh(newMesh, numFaces, indices);\n\n    this._prepareMeshAttributes(mesh, newMesh, numPoints, meshBuilder, decoder);\n\n    this.encoderModule.destroy(meshBuilder);\n\n    return newMesh;\n  }\n\n  _prepareMeshAttributes(mesh, newMesh, numPoints, meshBuilder, decoder) {\n    const attrs = {POSITION: 3, NORMAL: 3, COLOR: 3, TEX_COORD: 2};\n\n    Object.keys(attrs).forEach((attr) => {\n      const stride = attrs[attr];\n      const numValues = numPoints * stride;\n      const decoderAttr = this.decoderModule[attr];\n      const encoderAttr = this.encoderModule[attr];\n      const attrId = decoder.GetAttributeId(mesh, decoderAttr);\n\n      if (attrId < 0) {\n        return;\n      }\n\n      console.log(`Adding ${attr} attribute`);\n\n      const attribute = decoder.GetAttribute(mesh, attrId);\n      const attributeData = new this.decoderModule.DracoFloat32Array();\n      decoder.GetAttributeFloatForAllPoints(mesh, attribute, attributeData);\n\n      assert(numValues === attributeData.size(), 'Wrong attribute size.');\n\n      const attributeDataArray = new Float32Array(numValues);\n      for (let i = 0; i < numValues; ++i) {\n        attributeDataArray[i] = attributeData.GetValue(i);\n      }\n\n      this.decoderModule.destroy(attributeData);\n      meshBuilder.AddFloatAttributeToMesh(newMesh, encoderAttr, numPoints,\n          stride, attributeDataArray);\n    });\n  }\n}\n\n/*\n  encodeMesh(mesh, decoder) {\n    const encoder = new this.encoderModule.Encoder();\n    const meshBuilder = new this.encoderModule.MeshBuilder();\n\n    // Create a mesh object for storing mesh data.\n    const newMesh = new this.encoderModule.Mesh();\n\n    const numFaces = mesh.num_faces();\n    const numIndices = numFaces * 3;\n    const numPoints = mesh.num_points();\n    const indices = new Uint32Array(numIndices);\n\n    console.log(\"Number of faces \" + numFaces);\n    console.log(\"Number of vertices \" + numPoints);\n\n    // Add Faces to mesh\n    const ia = new this.decoderModule.DracoInt32Array();\n    for (let i = 0; i < numFaces; ++i) {\n      decoder.GetFaceFromMesh(mesh, i, ia);\n      const index = i * 3;\n      indices[index] = ia.GetValue(0);\n      indices[index + 1] = ia.GetValue(1);\n      indices[index + 2] = ia.GetValue(2);\n    }\n    this.decoderModule.destroy(ia);\n    meshBuilder.AddFacesToMesh(newMesh, numFaces, indices);\n\n    const attrs = {POSITION: 3, NORMAL: 3, COLOR: 3, TEX_COORD: 2};\n\n    Object.keys(attrs).forEach((attr) => {\n      const stride = attrs[attr];\n      const numValues = numPoints * stride;\n      const decoderAttr = this.decoderModule[attr];\n      const encoderAttr = this.encoderModule[attr];\n      const attrId = decoder.GetAttributeId(mesh, decoderAttr);\n\n      if (attrId < 0) {\n        return;\n      }\n\n      console.log(\"Adding %s attribute\", attr);\n\n      const attribute = decoder.GetAttribute(mesh, attrId);\n      const attributeData = new this.decoderModule.DracoFloat32Array();\n      decoder.GetAttributeFloatForAllPoints(mesh, attribute, attributeData);\n\n      assert(numValues === attributeData.size(), 'Wrong attribute size.');\n\n      const attributeDataArray = new Float32Array(numValues);\n      for (let i = 0; i < numValues; ++i) {\n        attributeDataArray[i] = attributeData.GetValue(i);\n      }\n\n      this.decoderModule.destroy(attributeData);\n      meshBuilder.AddFloatAttributeToMesh(newMesh, encoderAttr, numPoints,\n          stride, attributeDataArray);\n    });\n\n    let encodedData = new this.encoderModule.DracoInt8Array();\n    // Set encoding options.\n    encoder.SetSpeedOptions(5, 5);\n    encoder.SetAttributeQuantization(this.encoderModule.POSITION, 10);\n    encoder.SetEncodingMethod(this.encoderModule.MESH_EDGEBREAKER_ENCODING);\n\n    // Encoding.\n    console.log(\"Encoding...\");\n    const encodedLen = encoder.EncodeMeshToDracoBuffer(newMesh,\n                                                       encodedData);\n    this.encoderModule.destroy(newMesh);\n\n    if (encodedLen > 0) {\n      console.log(\"Encoded size is \" + encodedLen);\n    } else {\n      console.log(\"Error: Encoding failed.\");\n    }\n    // Copy encoded data to buffer.\n    const outputBuffer = new ArrayBuffer(encodedLen);\n    const outputData = new Int8Array(outputBuffer);\n    for (let i = 0; i < encodedLen; ++i) {\n      outputData[i] = encodedData.GetValue(i);\n    }\n\n    this.encoderModule.destroy(encodedData);\n    this.encoderModule.destroy(encoder);\n    this.encoderModule.destroy(meshBuilder);\n\n    return outputData;\n  }\n*/\n"],"file":"draco-encoder.js"}