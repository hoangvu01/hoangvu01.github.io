{"version":3,"sources":["../../../src/glb-loader/glb-parser.js"],"names":["unpackGLBBuffers","unpackBinaryJson","padTo4Bytes","TextDecoder","assert","MAGIC_glTF","GLB_FILE_HEADER_SIZE","GLB_CHUNK_HEADER_SIZE","GLB_CHUNK_TYPE_JSON","GLB_CHUNK_TYPE_BIN","LE","BE","getMagicString","dataView","String","fromCharCode","getUint8","GLBParser","constructor","glbArrayBuffer","parse","options","_parseBinary","json","binaryByteOffset","unpackedBuffers","unpackedJson","_getApplicationJSON","parseWithMetadata","jsonKey","glTF","Object","assign","magic","DataView","magic1","getUint32","version","fileLength","valid","console","warn","jsonChunkLength","jsonChunkFormat","jsonChunkOffset","jsonChunk","Uint8Array","textDecoder","jsonText","decode","JSON","binaryChunkStart","binChunkFormat","arrayBuffer"],"mappings":"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","sourcesContent":["/* eslint-disable camelcase, max-statements */\nimport unpackGLBBuffers from './unpack-glb-buffers';\nimport unpackBinaryJson from './unpack-binary-json';\nimport {padTo4Bytes} from '../common/loader-utils/array-utils';\nimport TextDecoder from '../common/loader-utils/text-decoder';\nimport assert from '../common/loader-utils/assert';\n\n// glTF CONSTANTS\n\nconst MAGIC_glTF = 0x676c5446; // glTF in Big-Endian ASCII\n\nconst GLB_FILE_HEADER_SIZE = 12;\nconst GLB_CHUNK_HEADER_SIZE = 8;\n\nconst GLB_CHUNK_TYPE_JSON = 0x4E4F534A;\nconst GLB_CHUNK_TYPE_BIN = 0x004E4942;\n\nconst LE = true; // Binary GLTF is little endian.\nconst BE = false; // Magic needs to be written as BE\n\n// glTF ACCESSOR CONSTANTS\n\n/*\nconst TYPE_COMPONENTS = {\n  SCALAR: 1,\n  VEC2: 2,\n  VEC3: 3,\n  VEC4: 4,\n  MAT2: 4,\n  MAT3: 9,\n  MAT4: 16\n};\n\nconst COMPONENT_TYPE_BYTE_SIZE = {\n  5120: 1,\n  5121: 1,\n  5122: 2,\n  5123: 2,\n  5125: 4,\n  5126: 4\n};\n\nconst COMPONENT_TYPE_ARRAY = {\n  5120: Int8Array,\n  5121: Uint8Array,\n  5122: Int16Array,\n  5123: Uint16Array,\n  5125: Uint32Array,\n  5126: Float32Array\n};\n*/\n\nfunction getMagicString(dataView) {\n  return `\\\n${String.fromCharCode(dataView.getUint8(0))}\\\n${String.fromCharCode(dataView.getUint8(1))}\\\n${String.fromCharCode(dataView.getUint8(2))}\\\n${String.fromCharCode(dataView.getUint8(3))}`;\n}\n\n// https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#glb-file-format-specification\nexport default class GLBParser {\n  constructor(glbArrayBuffer) {\n    this.glbArrayBuffer = glbArrayBuffer;\n  }\n\n  // Only returns application JSON\n  parse(options = {}) {\n    const {json, binaryByteOffset} = this._parseBinary(this.glbArrayBuffer, options);\n    const unpackedBuffers = unpackGLBBuffers(this.glbArrayBuffer, json, binaryByteOffset);\n    const unpackedJson = unpackBinaryJson(json, unpackedBuffers);\n    return this._getApplicationJSON(unpackedJson, options);\n  }\n\n  // Returns both application JSON and glTF JSON, separated\n  parseWithMetadata(options = {}) {\n    const {json, binaryByteOffset} = this._parseBinary(this.glbArrayBuffer, options);\n    const unpackedBuffers = unpackGLBBuffers(this.glbArrayBuffer, json, binaryByteOffset);\n    const unpackedJson = unpackBinaryJson(json, unpackedBuffers);\n    return unpackedJson;\n  }\n\n  // PRIVATE\n\n  // Get JSON from json key\n  _getApplicationJSON(json, options) {\n    const jsonKey = options.jsonKey || 'json';\n    // Create glTF metadata object, with deleted application json key\n    const glTF = Object.assign({}, json);\n    delete glTF[jsonKey];\n    return {json: json[jsonKey], glTF};\n  }\n\n  _parseBinary(options = {}) {\n    const {magic = MAGIC_glTF} = options;\n\n    // GLB Header\n    const dataView = new DataView(this.glbArrayBuffer);\n    const magic1 = dataView.getUint32(0, BE); // Magic number (the ASCII string 'glTF').\n    const version = dataView.getUint32(4, LE); // Version 2 of binary glTF container format\n    const fileLength = dataView.getUint32(8, LE); // Total byte length of generated file\n\n    let valid = magic1 === MAGIC_glTF || magic1 === magic;\n    if (!valid) {\n      console.warn(`Invalid GLB magic string ${getMagicString(dataView)}`); // eslint-disable-line\n    }\n\n    assert(version === 2, `Invalid GLB version ${version}. Only .glb v2 supported`);\n    assert(fileLength > 20);\n\n    // Write the JSON chunk\n    const jsonChunkLength = dataView.getUint32(12, LE); // Byte length of json chunk\n    const jsonChunkFormat = dataView.getUint32(16, LE); // Chunk format as uint32\n\n    valid = jsonChunkFormat === GLB_CHUNK_TYPE_JSON || jsonChunkFormat === 0; // Back compat\n    assert(valid, `JSON chunk format ${jsonChunkFormat}`);\n\n    // Create a \"view\" of the binary encoded JSON data\n    const jsonChunkOffset = GLB_FILE_HEADER_SIZE + GLB_CHUNK_HEADER_SIZE; // First headers: 20 bytes\n    const jsonChunk = new Uint8Array(this.glbArrayBuffer, jsonChunkOffset, jsonChunkLength);\n\n    // Decode the JSON binary array into clear text\n    const textDecoder = new TextDecoder('utf8');\n    const jsonText = textDecoder.decode(jsonChunk);\n\n    // Parse the JSON text into a JavaScript data structure\n    const json = JSON.parse(jsonText);\n\n    // TODO - BIN chunk can be optional\n    const binaryChunkStart = jsonChunkOffset + padTo4Bytes(jsonChunkLength);\n    const binaryByteOffset = binaryChunkStart + GLB_CHUNK_HEADER_SIZE;\n\n    const binChunkFormat = dataView.getUint32(binaryChunkStart + 4, LE); // Chunk format as uint32\n    valid = binChunkFormat === GLB_CHUNK_TYPE_BIN || binChunkFormat === 1; // Back compat\n    assert(valid, `BIN chunk format ${binChunkFormat}`);\n\n    return {arrayBuffer: this.glbArrayBuffer, binaryByteOffset, json};\n  }\n\n  /*\n  unpackBinaryObjects() {\n    const unpackedBinaryObjects = {\n      images: [],\n      accessors: []\n    };\n\n    const images = this.json.images || [];\n    for (const glTFImage of images) {\n      unpackedBinaryObjects.images.push(this.unpackImage(glTFImage));\n    }\n\n    const accessors = this.json.accessors || [];\n    for (const glTFAccessor of accessors) {\n      unpackedBinaryObjects.accessors.push(this.unpackAccessor(glTFAccessor));\n    }\n\n    return unpackedBinaryObjects;\n  }\n\n  unpackImage(glTFImage) {\n    /* global window, Blob, Image *\n    const arrayBufferView = this.unpackBufferView(glTFImage.bufferView);\n    const mimeType = glTFImage.mimeType || 'image/jpeg';\n    const blob = new Blob([arrayBufferView], {type: mimeType});\n    const urlCreator = window.URL || window.webkitURL;\n    const imageUrl = urlCreator.createObjectURL(blob);\n    const img = new Image();\n    img.src = imageUrl;\n    return img;\n  }\n\n  unpackAccessor(glTFAccessor) {\n    // Decode the glTF accessor format\n    const ArrayType = COMPONENT_TYPE_ARRAY[glTFAccessor.componentType];\n    const components = TYPE_COMPONENTS[glTFAccessor.type];\n    const bytesPerComponent = COMPONENT_TYPE_BYTE_SIZE[glTFAccessor.componentType];\n    const length = glTFAccessor.count * components;\n    const byteLength = glTFAccessor.count * components * bytesPerComponent;\n\n    // Get the boundaries of the binary sub-chunk for this bufferView\n    const glTFBufferView = this.json.bufferViews[glTFAccessor.bufferView];\n    assert(byteLength >= 0 && byteLength <= glTFBufferView.byteLength);\n\n    const byteOffset = glTFBufferView.byteOffset + this.binaryByteOffset;\n    return new ArrayType(this.arrayBuffer, byteOffset, length);\n  }\n\n  // Create a new typed array as a view into the binary chunk\n  unpackBufferView(glTFBufferView) {\n    const byteOffset = glTFBufferView.byteOffset + this.binaryByteOffset;\n    return new Uint8Array(byteOffset, glTFBufferView.byteLength);\n  }\n  */\n}\n"],"file":"glb-parser.js"}