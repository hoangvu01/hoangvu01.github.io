{"version":3,"sources":["../../../src/ply-loader/ply-process.old.js"],"names":["PLYParser","parsePLY","data","options","normalize","faceNormal","vertexNormal","flip","result","parser","onsuccess","parsedData","onerror","error","Error","parse","normalizeXYZ","vertex","face","normals","nx","generateNormals","ny","nz","header","attributes","x","y","z","vertex_indices","triangles","Array","length","fill","forEach","vertices","v0","v1","v2","x0","y0","z0","x1","y1","z1","v","magnitude","Math","sqrt","push","_","i","n","xMin","Infinity","yMin","zMin","xMax","yMax","zMax","min","max","scale","xMid","yMid","zMid"],"mappings":"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","sourcesContent":["import PLYParser from './ply-parser';\n\n/**\n * parse ply data\n * @param {Binary} data\n * @return {*} parsed point cloud\n */\nexport function parsePLY(data, options = {}) {\n  const {normalize = true, faceNormal = true, vertexNormal = true, flip = true} = options;\n\n  // Linearize the unnecessary callback interface from PLYloader\n  let result = null;\n  const parser = new PLYParser();\n  parser.onsuccess = parsedData => {\n    result = parsedData;\n  };\n  parser.onerror = error => {\n    throw new Error(error);\n  };\n  parser.parse(data);\n  if (result === null) {\n    throw new Error('PLY parsing failed');\n  }\n\n  if (normalize) {\n    normalizeXYZ(result.vertex);\n  }\n\n  // generate normals\n  if ((faceNormal && !result.face.normals) || (vertexNormal && !result.vertex.nx)) {\n    const {face, vertex} = generateNormals(result, flip);\n\n    if (faceNormal && !result.face.normals) {\n      result.face.normals = face;\n    }\n\n    if (vertexNormal && !result.vertex.nx) {\n      result.vertex.nx = vertex.nx;\n      result.vertex.ny = vertex.ny;\n      result.vertex.nz = vertex.nz;\n    }\n  }\n\n  return {\n    header: {},\n    attributes: result\n  };\n}\n\nexport function generateNormals({vertex: {x, y, z}, face: {vertex_indices: triangles}}, flip) {\n  const normals = {\n    face: [],\n    vertex: {\n      nx: Array(x.length).fill(0),\n      ny: Array(y.length).fill(0),\n      nz: Array(z.length).fill(0)\n    }\n  };\n\n  triangles.forEach(vertices => {\n    // get IDs of vertex in triangle\n    const v0 = vertices[0];\n    const v1 = vertices[1];\n    const v2 = vertices[2];\n    // get edge vectors of each triganle\n    const x0 = x[v2] - x[v0];\n    const y0 = y[v2] - y[v0];\n    const z0 = z[v2] - z[v0];\n    const x1 = x[v1] - x[v0];\n    const y1 = y[v1] - y[v0];\n    const z1 = z[v1] - z[v0];\n    // get cross-product betwee the two edge vectors\n    let nx = y0 * z1 - z0 * y1;\n    let ny = z0 * x1 - x0 * z1;\n    let nz = x0 * y1 - y0 * x1;\n    // sum per-triangle normal to adjacent vertex\n    vertices.forEach(v => {\n      normals.vertex.nx[v] += nx;\n      normals.vertex.ny[v] += ny;\n      normals.vertex.nz[v] += nz;\n    });\n    // normalize face normal\n    const magnitude = Math.sqrt(nx * nx + ny * ny + nz * nz);\n    nx = magnitude ? nx / magnitude : 0;\n    ny = magnitude ? ny / magnitude : 0;\n    nz = magnitude ? nz / magnitude : 0;\n    // add per-triangle normal\n    normals.face.push([nx, ny, nz]);\n  });\n\n  // normalize vertex normals\n  normals.vertex.nx.forEach((_, i) => {\n    const nx = normals.vertex.nx[i];\n    const ny = normals.vertex.ny[i];\n    const nz = normals.vertex.nz[i];\n    let magnitude = Math.sqrt(nx * nx + ny * ny + nz * nz);\n    magnitude *= flip ? -1 : 1;\n    normals.vertex.nx[i] = magnitude ? normals.vertex.nx[i] / magnitude : 0;\n    normals.vertex.ny[i] = magnitude ? normals.vertex.ny[i] / magnitude : 0;\n    normals.vertex.nz[i] = magnitude ? normals.vertex.nz[i] / magnitude : 0;\n  });\n\n  return normals;\n}\n\n/**\n * normalize ply data position\n * @param {object} vertex with attributes x, y z\n * @return {*} normalized point cloud\n */\nexport function normalizeXYZ({x, y, z}) {\n  const n = x.length;\n\n  let xMin = Infinity;\n  let yMin = Infinity;\n  let zMin = Infinity;\n  let xMax = -Infinity;\n  let yMax = -Infinity;\n  let zMax = -Infinity;\n\n  for (let i = 0; i < n; i++) {\n    xMin = Math.min(xMin, x[i]);\n    yMin = Math.min(yMin, y[i]);\n    zMin = Math.min(zMin, z[i]);\n    xMax = Math.max(xMax, x[i]);\n    yMax = Math.max(yMax, y[i]);\n    zMax = Math.max(zMax, z[i]);\n  }\n\n  const scale = Math.max(...[xMax - xMin, yMax - yMin, zMax - zMin]);\n\n  const xMid = (xMin + xMax) / 2;\n  const yMid = (yMin + yMax) / 2;\n  const zMid = (zMin + zMax) / 2;\n\n  for (let i = 0; i < n; i++) {\n    x[i] = (x[i] - xMid) / scale;\n    y[i] = (y[i] - yMid) / scale;\n    z[i] = (z[i] - zMid) / scale;\n  }\n}\n"],"file":"ply-process.old.js"}