{"version":3,"sources":["../../../src/glb-writer/glb-builder.js"],"names":["getImageSize","padTo4Bytes","copyArrayBuffer","TextEncoder","getAccessorType","getAccessorComponentType","MAGIC_glTF","LE","BE","GLB_FILE_HEADER_SIZE","GLB_CHUNK_HEADER_SIZE","GLBBuilder","rootPath","byteLength","json","buffers","bufferViews","accessors","images","sourceBuffers","arrayBuffer","byteOffset","parts","offset","contents","copy","sourceBuffer","accessor","size","bufferViewIndex","_addBufferView","glTFAccessor","bufferView","type","componentType","count","Math","round","length","push","imageData","error","glTFImage","sizeAndType","mimeType","width","height","Object","assign","_packBinaryChunk","options","_createGlbBuffer","buffer","totalByteLength","ArrayBuffer","targetArray","Uint8Array","i","sourceArray","set","appJson","binChunk","magic","console","warn","jsonChunkOffset","jsonChunk","convertObjectToJsonChunk","jsonChunkLength","binChunkOffset","fileLength","glbArrayBuffer","dataView","DataView","setUint32","binChunkLengthPadded","jsonChunkString","JSON","stringify","textEncoder","encode"],"mappings":"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","sourcesContent":["/* eslint-disable camelcase, max-statements */\nimport {getImageSize, padTo4Bytes, copyArrayBuffer, TextEncoder} from '../common/loader-utils';\nimport {getAccessorType, getAccessorComponentType} from './glb-accessor-utils';\n\nconst MAGIC_glTF = 0x676c5446; // glTF in Big-Endian ASCII\n\nconst LE = true; // Binary GLTF is little endian.\nconst BE = false; // Magic needs to be written as BE\n\nconst GLB_FILE_HEADER_SIZE = 12;\nconst GLB_CHUNK_HEADER_SIZE = 8;\n\nexport default class GLBBuilder {\n  constructor(rootPath) {\n    // Lets us keep track of how large the body will be, as well as the offset for each of the\n    // original buffers.\n    this.rootPath = rootPath;\n    this.byteLength = 0;\n\n    this.json = {\n      buffers: [\n        {\n          // Just the single BIN chunk buffer\n          byteLength: 0 // Updated at end of conversion\n        }\n      ],\n      bufferViews: [],\n      accessors: [],\n      images: []\n    };\n\n    // list of binary buffers to be written to the BIN chunk\n    // (Each call to addBuffer, addImage etc adds an entry here)\n    this.sourceBuffers = [];\n  }\n\n  getByteLength() {\n    return this.byteLength;\n  }\n\n  copyToArrayBuffer(arrayBuffer, byteOffset) {\n    for (const {offset, contents} of this.parts) {\n      contents.copy(arrayBuffer, byteOffset + offset);\n    }\n  }\n\n  // Add a binary buffer. Builds glTF \"JSON metadata\" and saves buffer reference\n  // Buffer will be copied into BIN chunk during \"pack\"\n  addBuffer(sourceBuffer, accessor = {size: 3}) {\n    const bufferViewIndex = this._addBufferView(sourceBuffer);\n\n    // Add an accessor pointing to the new buffer view\n    const glTFAccessor = {\n      bufferView: bufferViewIndex,\n      type: getAccessorType(accessor.size),\n      componentType: getAccessorComponentType(sourceBuffer),\n      count: Math.round(sourceBuffer.length / accessor.size)\n    };\n\n    this.json.accessors.push(glTFAccessor);\n\n    return this.json.accessors.length - 1;\n  }\n\n  // Checks if a binary buffer is a recognized image format (PNG, JPG, GIF, ...)\n  isImage(imageData) {\n    try {\n      getImageSize(imageData);\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n\n  // Adds a binary image. Builds glTF \"JSON metadata\" and saves buffer reference\n  // Buffer will be copied into BIN chunk during \"pack\"\n  addImage(imageData) {\n    const bufferViewIndex = this._addBufferView(imageData);\n\n    const glTFImage = {\n      bufferView: bufferViewIndex\n    };\n\n    // Get the properties of the image to add as metadata.\n    const sizeAndType = getImageSize(imageData);\n    if (sizeAndType) {\n      const {mimeType, width, height} = sizeAndType;\n      Object.assign(glTFImage, {mimeType, width, height});\n    }\n\n    this.json.images.push(glTFImage);\n\n    return this.json.images.length - 1;\n  }\n\n  pack() {\n    this._packBinaryChunk();\n    return {arrayBuffer: this.arrayBuffer, json: this.json};\n  }\n\n  encode(json, options = {}) {\n    return this._createGlbBuffer(json, options);\n  }\n\n  // PRIVATE\n\n  // Add one source buffer, create a matchibng glTF `bufferView`, and return its index\n  _addBufferView(buffer) {\n    const byteLength = buffer.byteLength || buffer.length;\n\n    // Add a bufferView indicating start and length of this binary sub-chunk\n    this.json.bufferViews.push({\n      buffer: 0,\n      // Write offset from the start of the binary body\n      byteOffset: this.byteLength,\n      byteLength\n    });\n\n    // We've now written the contents to the body, so update the total length\n    // Every sub-chunk needs to be 4-byte aligned\n    this.byteLength += padTo4Bytes(byteLength);\n\n    // Add this buffer to the list of buffers to be written to the body.\n    this.sourceBuffers.push(buffer);\n\n    // Return the index to the just created bufferView\n    return this.json.bufferViews.length - 1;\n  }\n\n  // Pack the binary chunk\n  _packBinaryChunk() {\n    // Already packed\n    if (this.arrayBuffer) {\n      return;\n    }\n\n    // Allocate total array\n    const totalByteLength = this.byteLength;\n    const arrayBuffer = new ArrayBuffer(totalByteLength);\n    const targetArray = new Uint8Array(arrayBuffer);\n\n    // Copy each array into\n    let byteOffset = 0;\n    for (let i = 0; i < this.sourceBuffers.length; i++) {\n      const sourceBuffer = this.sourceBuffers[i];\n      const byteLength = sourceBuffer.byteLength;\n\n      // Pack buffer onto the big target array\n      const sourceArray = new Uint8Array(sourceBuffer.buffer);\n      targetArray.set(sourceArray, byteOffset);\n\n      byteOffset += padTo4Bytes(byteLength);\n    }\n\n    // Update the glTF BIN CHUNK byte length\n    this.json.buffers[0].byteLength = totalByteLength;\n\n    // Save generated arrayBuffer\n    this.arrayBuffer = arrayBuffer;\n\n    // Clear out sourceBuffers\n    this.sourceBuffers = [];\n  }\n\n  // Encode the full GLB buffer with header etc\n  // https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#\n  // glb-file-format-specification\n  _createGlbBuffer(appJson, options = {}) {\n    // TODO - avoid double array buffer creation\n    this._packBinaryChunk();\n\n    this.json.json = appJson;\n\n    const binChunk = this.arrayBuffer;\n    if (options.magic) {\n      console.warn('Custom glTF magic number no longer supported'); // eslint-disable-line\n    }\n\n    const jsonChunkOffset = GLB_FILE_HEADER_SIZE + GLB_CHUNK_HEADER_SIZE; // First headers: 20 bytes\n\n    const jsonChunk = convertObjectToJsonChunk(this.json);\n    // As body is 4-byte aligned, the scene length must be padded to have a multiple of 4.\n    const jsonChunkLength = padTo4Bytes(jsonChunk.byteLength);\n\n    const binChunkOffset = jsonChunkLength + jsonChunkOffset;\n    const fileLength = binChunkOffset + GLB_CHUNK_HEADER_SIZE + padTo4Bytes(binChunk.byteLength);\n\n    // Length is know, we can create the GLB memory buffer!\n    const glbArrayBuffer = new ArrayBuffer(fileLength);\n    const dataView = new DataView(glbArrayBuffer);\n\n    // GLB Header\n    dataView.setUint32(0, MAGIC_glTF, BE); // Magic number (the ASCII string 'glTF').\n    dataView.setUint32(4, 2, LE); // Version 2 of binary glTF container format uint32\n    dataView.setUint32(8, fileLength, LE); // Total byte length of generated file (uint32)\n\n    // Write the JSON chunk\n    dataView.setUint32(12, jsonChunk.byteLength, LE); // Byte length of json chunk (uint32)\n    dataView.setUint32(16, 0, LE); // Chunk format as uint32 (JSON is 0)\n    copyArrayBuffer(glbArrayBuffer, jsonChunk, jsonChunkOffset);\n\n    // TODO - Add spaces as padding to ensure scene is a multiple of 4 bytes.\n    // for (let i = jsonChunkLength + 20; i < binChunkOffset; ++i) {\n    //   glbFileArray[i] = 0x20;\n    // }\n\n    // Write the BIN chunk\n    const binChunkLengthPadded = padTo4Bytes(binChunk.byteLength);\n    dataView.setUint32(binChunkOffset + 0, binChunkLengthPadded, LE); // Byte length BIN (uint32)\n    dataView.setUint32(binChunkOffset + 4, 1, LE); // Chunk format as uint32 (BIN is 1)\n    copyArrayBuffer(glbArrayBuffer, binChunk, binChunkOffset + GLB_CHUNK_HEADER_SIZE);\n\n    return glbArrayBuffer;\n  }\n}\n\nfunction convertObjectToJsonChunk(json) {\n  const jsonChunkString = JSON.stringify(json);\n  const textEncoder = new TextEncoder('utf8');\n  return textEncoder.encode(jsonChunkString);\n}\n"],"file":"glb-builder.js"}